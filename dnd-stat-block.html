<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dnd-stat-block-divider.html">

<dom-module id="dnd-stat-block">
  <link rel="import" type="css" href="basic-style.css">

  <template>

    <div class="bar"></div>

    <div class="content-wrapper">

      <content select="header"></content>

      <dnd-stat-block-divider></dnd-stat-block-divider>

      <div class="main-stats">
        <div>
          <content select="combat-stats"></content>
        </div>

      <dnd-stat-block-divider></dnd-stat-block-divider>

        <table class="ability-scores">
          <tr>
            <th>STR</th>
            <th>DEX</th>
            <th>CON</th>
            <th>INT</th>
            <th>WIS</th>
            <th>CHA</th>
          </tr>
          <tr>
            <td>{{strength}}</td>
            <td>{{dexterity}}</td>
            <td>{{constitution}}</td>
            <td>{{intelligence}}</td>
            <td>{{wisdom}}</td>
            <td>{{charisma}}</td>
          </tr>
        </table>

      <dnd-stat-block-divider></dnd-stat-block-divider>

        <div>
          <content select="stats"></content>
        </div>
      </div>

      <dnd-stat-block-divider></dnd-stat-block-divider>

      <div class="traits-and-actions">

        <content select="special-traits"></content>

        <content select="actions"></content>

        <content select="reactions"></content>

        <content select="legendary-actions"></content>

      </div>

    </div>

    <div class="bar"></div>

  </template>

  <script>

    HTMLImports.whenReady(function () {
      Polymer({
        is: 'dnd-stat-block',

        properties: {
          strength: {
            type: String,
            computed: 'computeAbilityScore(str)'
          },
          dexterity: {
            type: String,
            computed: 'computeAbilityScore(dex)'
          },
          constitution: {
            type: String,
            computed: 'computeAbilityScore(con)'
          },
          intelligence: {
            type: String,
            computed: 'computeAbilityScore(int)'
          },
          wisdom: {
            type: String,
            computed: 'computeAbilityScore(wis)'
          },
          charisma: {
            type: String,
            computed: 'computeAbilityScore(cha)'
          }
        },

        computeAbilityScore: function(score) {
          var bonus = Math.round((score / 2.1) - 5);
          if (bonus >=0) bonus = "+" + bonus;
          return score + " (" + bonus + ")";
        },

        ready: function() {

          // TODO refactor utility functions into separate module
          function toArray(nodelist) {
            return Array.prototype.slice.call(nodelist);
          }

          function flatten(arrays) {
            return [].concat.apply([], arrays);
          }

          function descriptionsToParagraphs(dl) {

            function toDescriptions(dts, dds) {
              return dts.map( function(dt, i) {
                var description = {};
                description.title = dt.innerHTML;
                description.description = dds[i].innerHTML;
                return description;
              });
            }

            function toParagraphs(description) {
              var p = document.createElement('p');
              var statNameSpan = document.createElement('span');
              statNameSpan.setAttribute("class", "stat-name");
              statNameSpan.innerHTML = description.title;
              p.appendChild(statNameSpan);
              if(description.description) {
                var statDescriptionSpan = document.createElement('span');
                statDescriptionSpan.setAttribute("class", "stat-description");
                statDescriptionSpan.innerHTML = " " + description.description;
                p.appendChild(statDescriptionSpan);
              }
              return p;
            }

            var dts = toArray(dl.getElementsByTagName('dt'));
            var dds = toArray(dl.getElementsByTagName('dd'));
            var descriptions = toDescriptions(dts, dds);
            return descriptions.map(toParagraphs);
          }

          function insertAfter(newNode, referenceNode) {
            referenceNode.parentNode.insertBefore(newNode, referenceNode);
          }

          function replaceChildren(parent, newNodes, oldNode) {;
            var lastNewNode = newNodes[newNodes.length - 1]
            parent.replaceChild(lastNewNode, oldNode);

            newNodes.pop();

            newNodes.forEach(function(child) {
              parent.insertBefore(child, lastNewNode);
            });
          }

          function convertStats(statsElement, template) {
            var stats = template.queryEffectiveChildren(statsElement);
            if(stats) {
              var dls = toArray(stats.getElementsByTagName('dl'));
              var ps = dls.map(descriptionsToParagraphs);

              dls.forEach(function(dl, i) {
                replaceChildren(stats, ps[i], dl);
              })
            }
          }

          convertStats('combat-stats', this);
          convertStats('stats', this);
          convertStats('special-traits', this);
          convertStats('actions', this);
          convertStats('reactions', this);
          convertStats('legendary-actions', this);
        }

      });

    });

  </script>

</dom-module>
