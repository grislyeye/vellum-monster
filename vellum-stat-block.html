<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="vellum-stat-block-divider.html">
<link rel="import" href="vellum-stat.html">
<link rel="import" href="vellum-spell-level.html">
<link rel="import" href="vellum-action.html">
<link rel="import" href="vellum-legendary-action.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer-microdata/polymer-microdata.html">

<dom-module id="vellum-stat-block">

  <link rel="import" type="css" href="basic-style.css">

  <template>

    <div class="bar"></div>

    <div class="content-wrapper">

      <header>
        <h1>{{name}}</h1>
        <p>{{size}} {{type}}<dom-if if={{alignment}}><template>, {{alignment}}</template></dom-if></p>
      </header>

      <vellum-stat-block-divider></vellum-stat-block-divider>

      <div class="main-stats">

        <div class="combat-stats">
          <vellum-stat id="ac" name="Armor Class" values$="{{ac}}"></vellum-stat>

          <dom-if if={{hitDie}}>
            <template>
              <vellum-stat id="hit-points-and-die" name="Hit Points" values$="{{hp}} ({{hitDie}})"></vellum-stat>
            </template>
          </dom-if>

          <dom-if if="{{!hitDie}}">
            <template>
              <vellum-stat id="hit-points" name="Hit Points" values$="{{hp}}"></vellum-stat>
            </template>
          </dom-if>

          <vellum-stat id="speed" name="Speed" values$="{{speeds}}"></vellum-stat>
        </div>

        <dom-if if={{hasAbilities}}>
          <template>
            <vellum-stat-block-divider></vellum-stat-block-divider>

            <table id="ability-scores">
              <tr>
                <th>STR</th>
                <th>DEX</th>
                <th>CON</th>
                <th>INT</th>
                <th>WIS</th>
                <th>CHA</th>
              </tr>
              <tr>
                <td>{{displayStrength}}</td>
                <td>{{displayDexterity}}</td>
                <td>{{displayConstitution}}</td>
                <td>{{displayIntelligence}}</td>
                <td>{{displayWisdom}}</td>
                <td>{{displayCharisma}}</td>
              </tr>
            </table>

            <vellum-stat-block-divider></vellum-stat-block-divider>
          </template>
        </dom-if>

        <div>

          <vellum-stat id="saving-throws" name="Saving Throws" values="{{savingThrows}}"></vellum-stat>
          <vellum-stat id="skills" name="Skills" values="{{skills}}"></vellum-stat>
          <vellum-stat id="damage-resistances" name="Damage Resistances" values="{{damageResistances}}"></vellum-stat>
          <vellum-stat id="damage-immunities" name="Damage Immunities" values="{{damageImmunities}}"></vellum-stat>
          <vellum-stat id="damage-threshold" name="Damage Threshold" values="{{damageThreshold}}"></vellum-stat>
          <vellum-stat id="condition-immunities" name="Condition Immunities" values="{{conditionImmunities}}"></vellum-stat>
          <vellum-stat id="senses" name="Senses" values="{{senses}}"></vellum-stat>
          <vellum-stat id="languages" name="Languages" values="{{languages}}"></vellum-stat>

          <dom-if if="{{cr}}">
            <template>
              <vellum-stat id="cr" name="Challenge" values="{{cr}} ({{xp}} XP)"></vellum-stat>
            </template>
          </dom-if>

        </div>

      </div>

      <vellum-stat-block-divider></vellum-stat-block-divider>

      <div class="traits-and-actions">
        <dom-repeat items="{{specialTraits}}">
          <template>
            <vellum-action id$="special-trait-{{index}}" action="{{item}}"></vellum-actions>
          </template>
        </dom-repeat>

        <dom-if if="{{spellcasting}}">
          <template>
            <vellum-action id="spellcasting" action="{{spellcastingAction}}"></vellum-action>
            <ul>
              <dom-repeat items={{spellcasting.levels}}>
                <template>
                  <li><vellum-spell-level id$="spell-level-{{index}}" level="{{item.level}}" slots="{{item.slots}}" spells={{item.spells}}></vellum-spell-level></li>
                </template>
              </dom-repeat>
            </ul>
          </template>
        </dom-if>

        <dom-if if={{actions}}>
          <template>
            <section id="actions">
              <h2>Actions</h2>

              <dom-repeat items="{{actions}}">
                <template>
                  <vellum-action id$="action-{{index}}" action="{{item}}"></vellum-stat>
                </template>
              </dom-repeat>
            </section>
          </template>
        </dom-if>

        <dom-if if="{{reactions}}">
          <template>
            <h2>Reactions</h2>

            <dom-repeat items="{{reactions}}">
              <template>
                <vellum-action id$="reaction-{{index}}" action="{{item}}"></vellum-stat>
              </template>
            </dom-repeat>
          </template>
        </dom-if>

        <dom-if if="{{legendaryActions}}">
          <template>
            <section class="legendary-actions">
              <h2>Legendary Actions</h2>

              <p>The {{lowerCaseName}} can take {{legendaryActions.number}} legendary actions, choosing from the options below. Only one legendary action can be used at a time, and only at the end of another creature's turn. Spent legendary actions are regained at the start of each turn.</p>

              <ul>
                <dom-repeat items={{legendaryActions.actions}}>
                  <template>
                    <li><vellum-legendary-action id$="legendary-action-{{index}}" action="{{item}}"></vellum-legendary-action></li>
                  </template>
                </dom-repeat>
              </ul>
            </section>

          </template>
        </dom-if>
      </div>

    </div>

    <div class="bar"></div>

  </template>

  <script>
    class StatBlock extends Microdata.Mixin(Polymer.Element) {

      static get is() { return 'vellum-stat-block'; }

      static get properties() {
        return {
          name: String,
          lowerCaseName: {
            type: String,
            computed: '_computerLowerCaseName(name)'
          },
          size: String,
          type: String,
          alignment: String,
          ac: Object,
          hp: String,
          hitDie: {
            type: String,
            value: ''
          },
          speeds: Array,
          str: Number,
          dex: Number,
          con: Number,
          int: Number,
          wis: Number,
          cha: Number,
          hasAbilities: {
            type: Boolean,
            computed: '_hasAbilities(str,dex,con,int,wis,cha)'
          },
          displayStrength: {
            type: String,
            computed: '_displayAbility(str)'
          },
          displayDexterity: {
            type: String,
            computed: '_displayAbility(dex)'
          },
          displayConstitution: {
            type: String,
            computed: '_displayAbility(con)'
          },
          displayIntelligence: {
            type: String,
            computed: '_displayAbility(int)'
          },
          displayWisdom: {
            type: String,
            computed: '_displayAbility(wis)'
          },
          displayCharisma: {
            type: String,
            computed: '_displayAbility(cha)'
          },
          savingThrows: Array,
          skills: Array,
          damageResistances: String,
          damageImmunities: Array,
          damageThreshold: Number,
          conditionImmunities: Array,
          senses: Array,
          languages: Array,
          cr: Number,
          xp: Number,
          specialTraits: Array,
          spellcasting: Object,
          spellcastingAction: {
            type: Object,
            computed: "_spellcastingAction(lowerCaseName, spellcasting)"
          },
          actions: Array,
          reactions: Array,
          legendaryActions: Object
        }
      }

      _hasAbilities(str, dex, con, int, wis, cha) {
        return (str != undefined && dex != undefined && con != undefined && int != undefined && wis != undefined && cha != undefined);
      }

      _displayAbility(ability) {
        const bonus = Math.round((ability / 2.1) - 5);

        if(bonus >= 0) return ability + ' (+' + bonus + ')';
        else return ability + ' (' + bonus + ')';
      }

      _computerLowerCaseName(name) {
        return name.toLowerCase();
      }

      _spellcastingAction(lowerCaseName, spellcasting) {
        if(spellcasting) {
          return {
            name: "Spellcasting",
            description: `
              The ${lowerCaseName} is a ${spellcasting.level}-level spellcaster.
              Its spellcasting ability is ${spellcasting.ability} (spell save DC ${spellcasting.save}, ${spellcasting.attackBonus} to hit with spell attacks), and ${spellcasting.notes}.
              The ${lowerCaseName} has the following ${spellcasting.class} spells prepared:`
          }
        }
      }
    }

    window.customElements.define(StatBlock.is, StatBlock);
  </script>
</dom-module>
